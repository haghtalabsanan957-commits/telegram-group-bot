import asyncio
import random
import sys
import os
import time
from rubpy import Client
from datetime import datetime

print("๐ค ุฑุจุงุช ุงุฑุณุงู ุฏูุฑูโุง")
print()

# ุณุดู ุซุงุจุช
SESSION_NAME = "rubika_session"

# ูุชุบุฑูุง ุขูุงุฑ
TOTAL_SENT = 0
TOTAL_FAILED = 0

# ูุณุช ูพุงูโูุง ุงููู (ฑฐฐ ูพุงู ูุฎุชูู)
INITIAL_MESSAGES = [
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู...",
    "ูุทูุงู ุตุจุฑ ฺฉูุฏ...",
    "ุงุฑุณุงู ูพุงู ุชุจูุบุงุช...",
    "ุขูุงุฏูโุณุงุฒ ูุญุชูุง...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ...",
    "ูุทูุงู ููุชุธุฑ ุจูุงูุฏ...",
    "ูพุงู ุฏุฑ ุญุงู ุงุฑุณุงู...",
    "ฺฉ ูุญุธู ุตุจุฑ ฺฉูุฏ...",
    "ุขูุงุฏูโุณุงุฒ ุงุทูุงุนุงุช...",
    "ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด...",
    "ุงุฑุณุงู ุจู ุฒูุฏ...",
    "ูพุงู ุชุจูุบุงุช ุฏุฑ ุฑุงู...",
    "ุขูุงุฏูโุณุงุฒ ฺฉุงูุงูโูุง...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูุญุชูุง...",
    "ูุทูุงู ุดฺฉุจุง ุจุงุดุฏ...",
    "ุฏุฑ ุญุงู ุชูุธู ูพุงู...",
    "ูพุงู ูฺู ุฏุฑ ุญุงู ุงุฑุณุงู...",
    "ูุญุธุงุช ุตุจุฑ ฺฉูุฏ...",
    "ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ...",
    "ุงุฑุณุงู ูพุงู ุชุจูุบุงุช...",
    "ฺฉ ูพุงู ูฺู ุจุฑุง ุดูุง...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูุญุชูุง...",
    "ูพุงู ุชุจูุบุงุช ูฺู...",
    "ูุทูุงู ููุชุธุฑ ูพุงู ุจุงุดุฏ...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ููู...",
    "ุขูุงุฏูโุณุงุฒ ุชุจูุบุงุช...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ุฌุฏุฏ...",
    "ูพุงู ููู ุฏุฑ ุฑุงู...",
    "ูุญุธุงุช ุฏฺฏุฑ...",
    "ุฏุฑ ุญุงู ุชูุธูุงุช ููุง...",
    "ุงุฑุณุงู ูพุงู ูฺู...",
    "ุขูุงุฏูโุณุงุฒ ูพุงู ุชุจูุบุงุช...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูุญุชูุง ุฌุฏุฏ...",
    "ูพุงู ุฌุฏุฏ ุฏุฑ ุฑุงู ุงุณุช...",
    "ูุทูุงู ููุชุธุฑ ุจูุงูุฏ...",
    "ุฏุฑ ุญุงู ุจุฑูุฒุฑุณุงู...",
    "ูพุงู ุชุจูุบุงุช ูฺู...",
    "ุขูุงุฏูโุณุงุฒ ุงุฑุณุงู...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู...",
    "ูพุงู ูฺู ุจุฑุง ฺฏุฑูู...",
    "ูุญุธุงุช ุตุจุฑ ฺฉูุฏ...",
    "ุฏุฑ ุญุงู ุชูุธู ูพุงู ุชุจูุบุงุช...",
    "ุงุฑุณุงู ูพุงู ุฌุฏุฏ...",
    "ูพุงู ููู ุฏุฑ ุญุงู ุงุฑุณุงู...",
    "ุขูุงุฏูโุณุงุฒ ุงุทูุงุนุงุช ุฌุฏุฏ...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงู...",
    "ูุทูุงู ุตุจุฑ ฺฉูุฏ...",
    "ูพุงู ุชุจูุบุงุช ุฏุฑ ุญุงู ุงุฑุณุงู...",
    "ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ ูุญุชูุง...",
    "ุงุฑุณุงู ุจู ุฒูุฏ ุงูุฌุงู ูโุดูุฏ...",
    "ูพุงู ูฺู ฺฏุฑูู...",
    "ูุญุธุงุช ุฏฺฏุฑ ูพุงู ุงุฑุณุงู ูโุดูุฏ...",
    "ุฏุฑ ุญุงู ุชูุธูุงุช ูพุงู...",
    "ุขูุงุฏูโุณุงุฒ ูพุงู ุฌุฏุฏ...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ุชุจูุบุงุช...",
    "ูพุงู ุฌุฏุฏ ุฏุฑ ุฑุงู ุงุณุช...",
    "ูุทูุงู ููุชุธุฑ ุจูุงูุฏ...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ุงุทูุงุนุงุช...",
    "ูพุงู ุชุจูุบุงุช ูฺู ฺฏุฑูู...",
    "ุขูุงุฏูโุณุงุฒ ุงุฑุณุงู ูพุงู...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูุญุชูุง ุชุจูุบุงุช...",
    "ูพุงู ูฺู ุฏุฑ ุฑุงู...",
    "ูุญุธุงุช ุตุจุฑ ฺฉูุฏ...",
    "ุฏุฑ ุญุงู ุชูุธูุงุช ููุง ูพุงู...",
    "ุงุฑุณุงู ูพุงู ุชุจูุบุงุช ุฌุฏุฏ...",
    "ูพุงู ููู ุจุฑุง ฺฏุฑูู...",
    "ุขูุงุฏูโุณุงุฒ ูุญุชูุง ุฌุฏุฏ...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ูฺู...",
    "ูพุงู ุชุจูุบุงุช ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ...",
    "ูุทูุงู ุตุจุฑ ฺฉูุฏ...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงู ุชุจูุบุงุช...",
    "ูพุงู ุฌุฏุฏ ุจุฑุง ฺฏุฑูู...",
    "ุขูุงุฏูโุณุงุฒ ุงุฑุณุงู ูฺู...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ููู...",
    "ูพุงู ุชุจูุบุงุช ูฺู ุฏุฑ ุฑุงู...",
    "ูุญุธุงุช ุฏฺฏุฑ...",
    "ุฏุฑ ุญุงู ุชูุธูุงุช ูพุงู ุชุจูุบุงุช...",
    "ุงุฑุณุงู ูพุงู ุฌุฏุฏ ฺฏุฑูู...",
    "ูพุงู ูฺู ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ...",
    "ุขูุงุฏูโุณุงุฒ ูุญุชูุง ุชุจูุบุงุช...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู...",
    "ูพุงู ุชุจูุบุงุช ุจุฑุง ฺฏุฑูู...",
    "ูุทูุงู ููุชุธุฑ ุจูุงูุฏ...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูุญุชูุง ูฺู...",
    "ูพุงู ุฌุฏุฏ ุชุจูุบุงุช...",
    "ุขูุงุฏูโุณุงุฒ ุงุฑุณุงู ูพุงู ูฺู...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ุชุจูุบุงุช ฺฏุฑูู...",
    "ูพุงู ููู ุฏุฑ ุฑุงู ุงุณุช...",
    "ูุญุธุงุช ุตุจุฑ ฺฉูุฏ...",
    "ุฏุฑ ุญุงู ุชูุธูุงุช ููุง ุงุฑุณุงู...",
    "ุงุฑุณุงู ูพุงู ุชุจูุบุงุช ูฺู...",
    "ูพุงู ุฌุฏุฏ ุจุฑุง ุงุนุถุง ฺฏุฑูู...",
    "ุขูุงุฏูโุณุงุฒ ูุญุชูุง ฺฏุฑูู...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ูฺู ฺฏุฑูู...",
    "ูพุงู ุชุจูุบุงุช ุฏุฑ ุฑุงู...",
    "ูุทูุงู ููุชุธุฑ ูพุงู ูฺู ุจุงุดุฏ...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงู ุฌุฏุฏ...",
    "ูพุงู ูฺู ุชุจูุบุงุช...",
    "ุขูุงุฏูโุณุงุฒ ุงุฑุณุงู ุจู ฺฏุฑูู...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ุชุจูุบุงุช ุฌุฏุฏ...",
    "ูพุงู ููู ุจุฑุง ุงุนุถุง ฺฏุฑูู...",
    "ูุญุธุงุช ุฏฺฏุฑ ูพุงู ุงุฑุณุงู ุฎูุงูุฏ ุดุฏ...",
    "ุฏุฑ ุญุงู ุชูุธูุงุช ูพุงู ฺฏุฑูู...",
    "ุงุฑุณุงู ูพุงู ุชุจูุบุงุช ูฺู ฺฏุฑูู...",
    "ูพุงู ุฌุฏุฏ ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ...",
    "ุขูุงุฏูโุณุงุฒ ูุญุชูุง ูฺู ฺฏุฑูู...",
    "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ุชุจูุบุงุช...",
    "ูพุงู ูฺู ุจุฑุง ุงุนุถุง ฺฏุฑูู...",
    "ูุทูุงู ุตุจุฑ ฺฉูุฏ...",
    "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงู ุชุจูุบุงุช ูฺู...",
    "ูพุงู ุฌุฏุฏ ุชุจูุบุงุช ฺฏุฑูู..."
]

# ุงููุฌโูุง ูุชููุน
EMOJIS = [
    "๐ฅ", "โญ", "๐ฎ", "๐", "๐", "โจ", "๐ฏ", "๐", "๐ซ", "โก",
    "๐", "๐ฅ", "๐", "๐", "๐ฏ", "โ", "๐๏ธ", "๐", "๐", "๐",
    "๐ฐ", "๐ต", "๐ธ", "๐ช", "๐", "๐ฎ", "๐น๏ธ", "๐ฒ", "โ๏ธ", "โฅ๏ธ",
    "โฆ๏ธ", "โฃ๏ธ", "๐", "๐ด", "๐พ", "๐น๏ธ", "๐ฌ", "๐ฑ", "๐ป", "๐ง",
    "๐ต", "๐ถ", "๐ข", "๐", "๐ค", "๐ฏ", "๐ช", "๐ก", "๐", "๐๏ธ",
    "๐ญ", "๐จ", "๐ผ๏ธ", "๐ธ", "๐ฅ", "๐บ", "๐๏ธ", "๐ฌ", "๐ฝ๏ธ", "๐ฐ",
    "๐", "๐", "๐", "๐", "๐", "๐๏ธ", "๐", "๐", "๐", "๐",
    "๐๏ธ", "๐", "๐", "๐๏ธ", "๐๏ธ", "โฐ๏ธ", "๐๏ธ", "๐ป", "๐", "๐๏ธ",
    "๐๏ธ", "โบ", "๐ค๏ธ", "๐ฃ๏ธ", "๐", "๐", "๐", "๐", "๐", "๐",
    "๐", "๐", "๐", "๐", "๐", "๐", "๐", "๐", "๐", "๐"
]

# ูพุงู ุงุตู ุซุงุจุช
MAIN_MESSAGE = """{emoji} ฺฏูพ ฺุช ฺฉุงูุงู : https://rubika.ir/joing/JDDGGBEB0FTCVEGLVJUOQLGNMZJYNMIK
{emoji} ุงฺฉุงูุช ุฑุงฺฏุงู ฺฉุงูุงู : @callofduty_mobile_2025"""

def get_random_emoji():
    """ุงูุชุฎุงุจ ุชุตุงุฏู ุงููุฌ"""
    return random.choice(EMOJIS)

def get_initial_message():
    """ุฏุฑุงูุช ูพุงู ุงููู ุชุตุงุฏู"""
    return random.choice(INITIAL_MESSAGES)

async def get_all_groups(client):
    """ุฏุฑุงูุช ููู ฺฏุฑููโูุง"""
    try:
        groups = []
        result = await client.get_chats()
        
        if hasattr(result, 'chats'):
            chats = result.chats
        elif isinstance(result, list):
            chats = result
        else:
            return []
        
        for chat in chats:
            guid = None
            if hasattr(chat, 'object_guid'):
                guid = chat.object_guid
            elif hasattr(chat, 'guid'):
                guid = chat.guid
            
            if guid and guid.startswith('g'):
                groups.append(guid)
        
        return groups
    except Exception:
        return []

async def send_initial_message(client, group_guid, message_index):
    """ุงุฑุณุงู ูพุงู ุงููู"""
    global TOTAL_SENT, TOTAL_FAILED
    
    try:
        # ุงุณุชูุงุฏู ุงุฒ ูพุงู ุงููู ุจุฑ ุงุณุงุณ index (ุจุฑุง ููุจุช ุจูุฏู)
        initial_msg = INITIAL_MESSAGES[message_index % len(INITIAL_MESSAGES)]
        sent_msg = await client.send_message(group_guid, initial_msg)
        return sent_msg
    except Exception as e:
        TOTAL_FAILED += 1
        return None

async def edit_to_main_message(client, group_guid, initial_message, message_id):
    """ูุฑุงุด ูพุงู ุงููู ุจู ูพุงู ุงุตู"""
    global TOTAL_SENT
    
    try:
        # ุงูุชุฎุงุจ ุงููุฌ ุชุตุงุฏู ุจุฑุง ูพุงู ุงุตู
        emoji = get_random_emoji()
        main_msg = MAIN_MESSAGE.format(emoji=emoji)
        
        # ูุฑุงุด ูพุงู
        await client.edit_message(
            object_guid=group_guid,
            message_id=message_id,
            text=main_msg
        )
        TOTAL_SENT += 1
        return True
    except Exception as e:
        return False

async def send_to_group(client, group_guid, message_counter):
    """ุงุฑุณุงู ูพุงู ุจู ฺฉ ฺฏุฑูู ุจุง ูพุงู ุงููู ู ูุฑุงุด"""
    global TOTAL_FAILED
    
    try:
        # ุงุฑุณุงู ูพุงู ุงููู
        initial_msg_obj = await send_initial_message(client, group_guid, message_counter)
        
        if initial_msg_obj is None:
            TOTAL_FAILED += 1
            return False
        
        # ุงุณุชุฎุฑุงุฌ message_id ุงุฒ ุดุก ุจุฑฺฏุดุช
        message_id = None
        if hasattr(initial_msg_obj, 'message_id'):
            message_id = initial_msg_obj.message_id
        elif isinstance(initial_msg_obj, dict) and 'message_id' in initial_msg_obj:
            message_id = initial_msg_obj['message_id']
        
        if not message_id:
            TOTAL_FAILED += 1
            return False
        
        # ุชุงุฎุฑ ฐ.ฑ ุซุงูู
        await asyncio.sleep(0.1)
        
        # ูุฑุงุด ุจู ูพุงู ุงุตู
        success = await edit_to_main_message(client, group_guid, None, message_id)
        
        if not success:
            TOTAL_FAILED += 1
            return False
            
        return True
        
    except Exception as e:
        TOTAL_FAILED += 1
        return False

async def periodic_sender():
    """ุฑุจุงุช ุงุฑุณุงู ุฏูุฑูโุง"""
    global TOTAL_SENT, TOTAL_FAILED
    
    try:
        # ุงุชุตุงู ุจุง ุณุดู ุซุงุจุช
        client = Client(SESSION_NAME)
        await client.start()
        
        # ูพุงฺฉ ฺฉุฑุฏู ุชุฑููุงู
        os.system('cls' if sys.platform == "win32" else 'clear')
        print("๐ค ุฑุจุงุช ูุนุงู - ุงุฑุณุงู ูุฑ ฒ-ณ ุฏููู")
        print("๐ฎ ุงุฑุณุงู ูพุงู ุงููู + ูุฑุงุด ุจุนุฏ ุงุฒ ฐ.ฑ ุซุงูู")
        print("โจ ฑฐฐ ูพุงู ุงููู ูุฎุชูู ููุจุช")
        print("="*50)
        
        cycle = 1
        message_counter = 0  # ุดูุงุฑูุฏู ุจุฑุง ูพุงูโูุง ููุจุช
        
        while True:
            try:
                # ุฏุฑุงูุช ฺฏุฑููโูุง
                groups = await get_all_groups(client)
                
                if not groups:
                    print(f"ุฏูุฑ {cycle}: โ ฺฏุฑูู ุงูุช ูุดุฏ")
                    await asyncio.sleep(180)  # 3 ุฏููู
                    cycle += 1
                    continue
                
                # ุขูุงุฑ ุงู ุฏูุฑ
                sent_in_cycle = 0
                failed_in_cycle = 0
                
                # ุงุฑุณุงู ุจู ููู ฺฏุฑููโูุง
                for i, group_guid in enumerate(groups, 1):
                    try:
                        success = await send_to_group(client, group_guid, message_counter)
                        
                        if success:
                            sent_in_cycle += 1
                        else:
                            failed_in_cycle += 1
                        
                        # ุงูุฒุงุด ุดูุงุฑูุฏู ุจุฑุง ูพุงู ุจุนุฏ ููุจุช
                        message_counter = (message_counter + 1) % len(INITIAL_MESSAGES)
                        
                        # ุชุงุฎุฑ ฒ-ณ ุซุงูู ุจู ุงุฑุณุงูโูุง
                        delay = random.uniform(2.0, 3.0)
                        await asyncio.sleep(delay)
                        
                    except Exception as e:
                        failed_in_cycle += 1
                        # ุงูุฒุงุด ุดูุงุฑูุฏู ุญุช ุฏุฑ ุตูุฑุช ุฎุทุง
                        message_counter = (message_counter + 1) % len(INITIAL_MESSAGES)
                        await asyncio.sleep(2.5)
                
                # ููุงุด ุขูุงุฑ ุงู ุฏูุฑ
                print(f"ุฏูุฑ {cycle}: โ {sent_in_cycle} | โ {failed_in_cycle} | ฺฉู ฺฏุฑููโูุง: {len(groups)}")
                print(f"   ุดูุงุฑูุฏู ูพุงู: {message_counter}/{len(INITIAL_MESSAGES)}")
                
                # ุชุงุฎุฑ ฒ-ณ ุฏููู ุชุง ุฏูุฑ ุจุนุฏ
                delay_minutes = random.uniform(2.0, 3.0)
                delay_seconds = int(delay_minutes * 60)
                
                # ููุงุด ุฒูุงู ุจุงูโูุงูุฏู
                for remaining in range(delay_seconds, 0, -1):
                    if remaining % 30 == 0 or remaining <= 5:
                        mins = remaining // 60
                        secs = remaining % 60
                        print(f"\rโณ ุฏูุฑ ุจุนุฏ: {mins:02d}:{secs:02d} | ูพุงู ุจุนุฏ: {INITIAL_MESSAGES[message_counter][:20]}...", end="", flush=True)
                    await asyncio.sleep(1)
                print()
                
                cycle += 1
                
            except Exception as e:
                print(f"ุฎุทุง ุฏุฑ ุฏูุฑ {cycle}: {str(e)[:50]}")
                await asyncio.sleep(180)
                cycle += 1
                
    except KeyboardInterrupt:
        print(f"\n\n๐ ุขูุงุฑ ููุง: โ {TOTAL_SENT} | โ {TOTAL_FAILED}")
        try:
            await client.disconnect()
        except:
            pass
        
    except Exception as e:
        print(f"\nโ ุฎุทุง ุงุตู: {str(e)[:50]}")
        try:
            await client.disconnect()
        except:
            pass

# ุงุฌุฑุง ุฑุจุงุช
if __name__ == "__main__":
    try:
        # ูพุงฺฉ ฺฉุฑุฏู ุชุฑููุงู
        os.system('cls' if sys.platform == "win32" else 'clear')
        
        print("="*50)
        print("๐ค ุฑุจุงุช ุงุฑุณุงู ุฏูุฑูโุง ุฑูุจฺฉุง")
        print("="*50)
        print("๐ฎ ูฺฺฏโูุง ุฌุฏุฏ:")
        print("  โข ุงุฑุณุงู ูุฑ ฒ-ณ ุฏููู")
        print("  โข ุชุงุฎุฑ ฒ-ณ ุซุงูู ุจู ูพุงูโูุง")
        print("  โข ฑฐฐ ูพุงู ุงููู ูุฎุชูู (ููุจุช)")
        print("  โข ูุฑุงุด ูพุงู ุจุนุฏ ุงุฒ ฐ.ฑ ุซุงูู")
        print("  โข ุงููุฌโูุง ูุชููุน ู ุชุตุงุฏู")
        print("  โข ุณุดู ูุจู ุญูุธ ูโุดูุฏ")
        print(f"  โข {len(INITIAL_MESSAGES)} ูพุงู ุงููู ุขูุงุฏู")
        print(f"  โข {len(EMOJIS)} ุงููุฌ ูุชููุน")
        print("="*50)
        
        print("\n๐ ุดุฑูุน ุฏุฑ 5 ุซุงูู...")
        for i in range(5, 0, -1):
            print(f"\r   {i}...", end="", flush=True)
            time.sleep(1)
        print("\n")
        
        asyncio.run(periodic_sender())
        
    except KeyboardInterrupt:
        print("\n\n๐ ุฑุจุงุช ูุชููู ุดุฏ")
        sys.exit(0)